<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>My Watchlist</title>
  <style>
    :root {
      --bg: #f5f7fa;
      --card: #ffffff;
      --primary: #4f46e5;
      --text: #111827;
      --muted: #6b7280;
      --danger: #ef4444;
      --star: #fbbf24;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,sans-serif}
    body{background:var(--bg);color:var(--text);display:flex;min-height:100vh}
    aside{width:320px;flex-shrink:0;background:#fff;border-right:1px solid #e5e7eb;padding:1rem;overflow-y:auto}
    main{flex:1;padding:1rem}
    h1,h2{margin-bottom:1rem;font-size:1.25rem}
    .search-bar{display:flex;gap:.5rem;margin-bottom:1rem}
    .search-bar input{flex:1;padding:.75rem;border:1px solid #d1d5db;border-radius:.5rem}
    .search-bar button{padding:.75rem;background:var(--primary);color:#fff;border:none;border-radius:.5rem;cursor:pointer}
    .card{display:flex;gap:.75rem;background:var(--card);border-radius:.5rem;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.05);margin-bottom:.75rem}
    .card img{width:90px;height:135px;object-fit:cover;flex-shrink:0}
    .info{padding:.5rem;font-size:.8rem;display:flex;flex-direction:column;justify-content:space-between}
    .info h3 a{color:var(--primary);text-decoration:none}
    .info p{margin:.1rem 0;color:var(--muted)}
    .btn-mini{padding:.25rem .5rem;font-size:.7rem;border:none;border-radius:.25rem;cursor:pointer;transition:.2s}
    .btn-mini.watch{background:var(--primary);color:#fff}
    .btn-mini.watch:hover{background:#3730a3}
    .btn-mini.remove{background:var(--danger);color:#fff}
    .btn-mini.remove:hover{background:#c33}
    .star{color:#d1d5db;font-size:.9rem;cursor:pointer}
    .star.active{color:var(--star)}
    .load-more{display:block;margin:1rem auto;padding:.5rem 1rem;background:var(--primary);color:#fff;border:none;border-radius:.5rem;cursor:pointer}
    .hidden{display:none}
    @media(max-width:700px){body{flex-direction:column}aside{width:100%;border-right:none;border-bottom:1px solid #e5e7eb}}
  </style>
</head>
<body>

  <!-- SIDEBAR (SUDAH DITONTON) -->
  <aside>
    <h2>Sudah Ditonton</h2>
    <div id="watchlistItems"></div>
  </aside>

  <!-- MAIN (PENCARIAN) -->
  <main>
    <h1>My Watchlist</h1>
    <div class="search-bar">
      <input id="keyword" type="text" placeholder="Cari film..." />
      <button id="searchBtn">Cari</button>
    </div>

    <div id="results"></div>
    <button id="loadMoreBtn" class="load-more hidden">Load More</button>
  </main>

  <script>
    const API_KEY = 'db560b79';
    const watchlist = JSON.parse(localStorage.getItem('watchlist')) || [];
    let allResults = [];
    let currentIndex = 0;
    const STEP = 5;

    // helpers
    const trID = async (t) => {
      if (!t || t === 'N/A') return 'Sinopsis tidak tersedia';
      try {
        const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=id&dt=t&q=${encodeURIComponent(t)}`);
        return (await res.json())[0][0][0] || t;
      } catch { return t; }
    };
    const imdbLink = (txt, type = 'name') => {
      const base = type === 'genre' ? 'https://www.imdb.com/search/title/?genres=' : 'https://www.imdb.com/find/?q=';
      return `<a href="${base}${encodeURIComponent(txt)}" target="_blank" rel="noopener">${txt}</a>`;
    };

    // enter key
    document.getElementById('keyword').addEventListener('keydown', e => { if (e.key === 'Enter') searchMovie(); });
    document.getElementById('searchBtn').addEventListener('click', searchMovie);

    // search
    async function searchMovie() {
      const kw = document.getElementById('keyword').value.trim();
      if (!kw) return;
      const pages = [1, 2, 3, 4, 5];
      let raw = [];
      for (const p of pages) {
        const res = await fetch(`https://www.omdbapi.com/?apikey=${API_KEY}&s=${encodeURIComponent(kw)}&type=movie&page=${p}`);
        const data = await res.json();
        if (data.Response === 'True') raw.push(...data.Search); else break;
      }
      const seen = new Set();
      allResults = raw.filter(m => !seen.has(m.imdbID) && seen.add(m.imdbID)).slice(0, 50);
      currentIndex = 0;
      renderResults(true);
    }

    async function renderResults(clear = true) {
      const box = document.getElementById('results');
      const btn = document.getElementById('loadMoreBtn');
      if (clear) box.innerHTML = '';

      const slice = allResults.slice(currentIndex, currentIndex + STEP);
      for (const m of slice) {
        const d = await (await fetch(`https://www.omdbapi.com/?apikey=${API_KEY}&i=${m.imdbID}&plot=short`)).json();
        const plot = await trID(d.Plot);
        const actors = d.Actors !== 'N/A' ? d.Actors.split(',').slice(0, 5).map(a => imdbLink(a.trim())).join(', ') : 'Tidak tersedia';
        const genres = d.Genre !== 'N/A' ? d.Genre.split(',').slice(0, 5).map(g => imdbLink(g.trim(), 'genre')).join(', ') : 'Tidak tersedia';
        const director = d.Director !== 'N/A' ? imdbLink(d.Director.trim()) : 'Tidak tersedia';

        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <img src="${m.Poster !== 'N/A' ? m.Poster : 'https://via.placeholder.com/90x135?text=No+Image'}" alt="${m.Title}">
          <div class="info">
            <h3>${imdbLink(`${m.Title} (${m.Year})`, 'title')}</h3>
            <p><strong>Sutradara:</strong> ${director}</p>
            <p><strong>Pemeran:</strong> ${actors}</p>
            <p><strong>Genre:</strong> ${genres}</p>
            <p><strong>Sinopsis:</strong> ${plot}</p>
            <button class="btn-mini watch" onclick="addToWatchlist('${m.imdbID}')">+ Watchlist</button>
          </div>
        `;
        box.appendChild(el);
      }
      currentIndex += STEP;
      btn.classList.toggle('hidden', currentIndex >= allResults.length);
    }

    document.getElementById('loadMoreBtn').addEventListener('click', () => renderResults(false));

    // watchlist
    async function addToWatchlist(id) {
      if (watchlist.some(w => w.id === id)) return alert('Sudah ada di watchlist');
      const d = await (await fetch(`https://www.omdbapi.com/?apikey=${API_KEY}&i=${id}&plot=short`)).json();
      const plot = await trID(d.Plot);
      watchlist.unshift({
        id: d.imdbID,
        title: d.Title,
        year: d.Year,
        poster: d.Poster,
        plot,
        director: d.Director,
        actors: d.Actors,
        genres: d.Genre,
        rating: 0
      });
      localStorage.setItem('watchlist', JSON.stringify(watchlist));
      renderWatchlist();
    }

    function renderWatchlist() {
      const box = document.getElementById('watchlistItems');
      box.innerHTML = watchlist.length
        ? ''
        : '<p style="text-align:center;color:var(--muted)">Belum ada film ditonton</p>';
      watchlist.forEach((m, i) => {
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <img src="${m.poster !== 'N/A' ? m.poster : 'https://via.placeholder.com/90x135?text=No+Image'}" alt="${m.title}">
          <div class="info">
            <h3>${imdbLink(`${m.title} (${m.year})`, 'title')}</h3>
            <p><strong>Sutradara:</strong> ${imdbLink(m.director)}</p>
            <p><strong>Pemeran:</strong> ${m.actors.split(',').map(a => imdbLink(a.trim())).join(', ')}</p>
            <p><strong>Genre:</strong> ${m.genres.split(',').map(g => imdbLink(g.trim(), 'genre')).join(', ')}</p>
            <p><strong>Sinopsis:</strong> ${m.plot}</p>
            <div>${[...Array(5)].map((_, idx) =>
              `<span class="star ${idx < m.rating ? 'active' : ''}" onclick="rate(${i}, ${idx + 1})">â˜…</span>`
            ).join('')}</div>
            <button class="btn-mini remove" onclick="remove(${i})">Hapus</button>
          </div>
        `;
        box.appendChild(el);
      });
    }

    function rate(i, stars) {
      watchlist[i].rating = stars;
      localStorage.setItem('watchlist', JSON.stringify(watchlist));
      renderWatchlist();
    }
    function remove(i) {
      watchlist.splice(i, 1);
      localStorage.setItem('watchlist', JSON.stringify(watchlist));
      renderWatchlist();
    }

    renderWatchlist();
  </script>
</body>
</html>
